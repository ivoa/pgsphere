CREATE TABLE points (id int, p spoint, pos int);
INSERT INTO points (id, p) SELECT x, spoint(random()*6.28, (2*random()-1)*1.57) FROM generate_series(1,314159) x;
CREATE INDEX i ON points USING gist (p spoint3);
SET enable_indexscan = true;
EXPLAIN (costs off) SELECT p <-> spoint (0.2, 0.3) FROM points ORDER BY 1 LIMIT 10;
                   QUERY PLAN                    
-------------------------------------------------
 Limit
   ->  Index Only Scan using i on points
         Order By: (p <-> '(0.2 , 0.3)'::spoint)
(3 rows)

UPDATE points SET pos = n FROM (SELECT id, row_number() OVER (ORDER BY p <-> spoint (0.2, 0.3)) n  FROM points ORDER BY p <-> spoint (0.2, 0.3) LIMIT 10) sel WHERE points.id = sel.id;
SET enable_indexscan = false;
SET enable_indexonlyscan = false;
EXPLAIN (costs off) SELECT p <-> spoint (0.2, 0.3) FROM points ORDER BY 1 LIMIT 10;
                    QUERY PLAN                     
---------------------------------------------------
 Limit
   ->  Sort
         Sort Key: ((p <-> '(0.2 , 0.3)'::spoint))
         ->  Seq Scan on points
(4 rows)

SELECT pos, row_number() OVER (ORDER BY p <-> spoint (0.2, 0.3)) n  FROM points ORDER BY p <-> spoint (0.2, 0.3) LIMIT 10;
 pos | n  
-----+----
   1 |  1
   2 |  2
   3 |  3
   4 |  4
   5 |  5
   6 |  6
   7 |  7
   8 |  8
   9 |  9
  10 | 10
(10 rows)

DROP TABLE points;
